name: Manual Test Workflow

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Verify environment variables
      run: |
        echo "GCP Project ID: ${{ secrets.GCLOUD_PROJECT }}"
        echo "GKE Cluster: ${{ secrets.GKE_CLUSTER }}"
        echo "GCP Region: ${{ secrets.GCLOUD_REGION }}"
        echo "JSOM : ${{ secrets.GCP_CREDENTIALS }}"
      
    - name: Checkout code
      uses: actions/checkout@v2
    
    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'

    - name: 'Use gcloud CLI'
      run: 'gcloud info'

    - name: Build and Push Docker image
      run: |
        IMAGE_NAME=gcr.io/${{ secrets.GCLOUD_PROJECT }}/xgboost-tuning-task2
        docker build -t $IMAGE_NAME:latest .
        docker push $IMAGE_NAME:latest

    - name: Configure kubectl
      run: |
        gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} --zone ${{ secrets.GCLOUD_REGION }}

    - name: Deploy to GKE
      run: |
        kubectl apply -f tuning-job.yaml
